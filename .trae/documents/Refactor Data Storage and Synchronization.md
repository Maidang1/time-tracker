# 数据存储与同步重构方案 (业界最佳实践版)

本方案整合了离线优先（Offline-First）、请求队列、增量冲突解决等业界最佳实践，旨在打造健壮、流畅的移动端数据体验。

## 核心架构：离线队列与双写机制

### 1. `DataManager` 深度重构

我们将引入 **操作队列 (Action Queue)** 机制，替代简单的即时请求。

*   **状态管理**:
    *   `events`: 内存中的事件数据（UI 数据源）。
    *   `actionQueue`: 待同步的操作队列 `[{ id, type, payload, timestamp }]`。
    *   `storage`: 持久化存储 `events` 和 `actionQueue`。

*   **初始化 (`initialize`)**:
    1.  **极速启动**: 从本地缓存加载 `events` 和 `actionQueue`。立即渲染 UI。
    2.  **自动恢复**: 如果 `actionQueue` 中有遗留任务，立即触发 `processQueue()`。
    3.  **后台拉取**: 启动 `syncFromCloud()` 获取最新数据。

*   **写操作流程 (`create`/`update`/`delete`)**:
    1.  **乐观更新 (Optimistic)**: 立即修改内存 `events`，更新 UI。
    2.  **入队 (Enqueue)**: 将操作封装为 Task 存入 `actionQueue` 并持久化。
    3.  **触发处理**: 尝试调用 `processQueue()`。

*   **队列处理 (`processQueue`)**:
    *   按顺序取出队列中的任务。
    *   **网络检查**: 如离线，暂停处理（保留在队列中等待网络恢复）。
    *   **执行同步**: 调用云数据库 API。
    *   **成功**: 从队列移除任务，更新本地缓存，继续下一个。
    *   **失败**:
        *   **可重试错误 (网络波动)**: 停止处理，保留队列，等待下次触发。
        *   **不可重试错误 (权限/校验)**: 移除任务或标记为错误，**触发错误回调（弹窗）**。

*   **云端拉取 (`syncFromCloud`)**:
    *   **分页循环**: 处理云数据库 20 条限制，循环拉取直至获取全部。
    *   **冲突解决 (Conflict Resolution)**:
        *   使用 `updatedAt` 字段。
        *   仅当 `cloudEvent.updatedAt > localEvent.updatedAt` 且该事件不在当前 `actionQueue`（即没有正在进行的本地修改）时，才覆盖本地数据。
        *   这保护了用户刚才离线编辑的内容不被旧的云端数据覆盖。

### 2. UI 交互层更新

*   **无感知体验**:
    *   在网络正常或暂时离线时，用户操作如常，无 Loading，无报错。系统在后台自动重试。

*   **异常介入**:
    *   仅在**同步彻底失败**（如云端拒绝写入）时，调用 `SyncErrorCallback`。
    *   **UI 表现**: 使用 `Taro.showModal` 提示错误。
    *   **重试机制**: 点击“重试”将再次触发 `processQueue()`。

### 3. 数据结构增强
*   `EventItem` 增加 `updatedAt` (ISO String)。
*   新增 `SyncTask` 类型定义。

## 方案优势
1.  **完全离线支持**: 即使在飞机上（无网），用户也能创建/编辑，数据保存在队列中，联网后自动上传。
2.  **数据一致性**: 通过 `updatedAt` 和队列锁机制，防止新数据被旧数据覆盖。
3.  **极致流畅**: 只有在真正的系统性错误发生时才打扰用户，常规网络波动由队列自动消化。
